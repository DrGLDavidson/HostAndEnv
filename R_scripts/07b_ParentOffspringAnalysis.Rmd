---
title: "R Notebook"
output: html_notebook
---

Parent-offspring analysis, JQ request 1 June 2022
Are offspring microbiome traits correlated with parent traits, controlling for woodland site etc.
Related to repeatability discussion

```{r}
rm(list=ls())
```

```{r}
library(lme4)
library(phyloseq)
library(microbiome)
library(tidyverse)
library(lmerTest)
library(kableExtra)
```

```{r}
nstlng.adult.df <- readRDS("../Data/ParentOffspringDF.rds")
```


# Both parents
### Shannon

Both parents correlation with nestling
* ensure only nests with both parents sampled included (38 or 39???)
* control for age, has to be fixed effect due to few factor levels or use nestling ID as random term
* dont think i need to centre and scale because on same scale?
```{r, echo=FALSE, eval=FALSE}
#offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon*ageBinned*m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)
offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon + m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)

#summary(offspring.parents.shannon)

# standardize
summary(arm::standardize(offspring.parents.shannon))
```

### chao
```{r, echo=FALSE, eval=FALSE}
offspring.parents.chao <- lmer(nst.chao1 ~ fe.chao1 + m.chao1 + (1|site/nest/bird.ID), data = nstlng.adult.df)
# standardize
summary(arm::standardize(offspring.parents.chao))
```

How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r, echo=FALSE, eval=FALSE}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

# using adult abundance directly
#offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu + m.pro.abu + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
#summary(arm::standardize(offspring.parents.proteo))

# using adult abundance as fraction
offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu.RA + m.pro.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.proteo))

#  ageBinned * habitat + ageBinned * layDateFirst + ageBinned * broodSizeWhenSampled + ageBinned * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, weights = NumberOfReads, data = proteobacteria.df) # , REML=FALSE not valid argument
```

### Firmicutes RA

```{r, echo=FALSE, eval=FALSE}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.parents.firmic <- glmer(binomial.response ~  fe.fir.abu.RA + m.fir.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.firmic))
```

# Female only
### shannon

```{r}
offspring.female.shannon <- lmer(nst.shannon ~ fe.shannon * ageBinned + ageBinned * habitat+ (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.female.shannon))
```

### chao
```{r}
offspring.female.chao <- lmer(log(nst.chao1) ~ fe.chao1*ageBinned + ageBinned * habitat+ (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.female.chao))
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.female.proteo <- glmer(binomial.response ~  fe.pro.abu.RA*ageBinned + ageBinned*habitat + ageBinned*broodSizeWhenSampled + ageBinned*DistanceToEdge + ageBinned*layDateFirst + habitat*broodSizeWhenSampled + habitat*DistanceToEdge + broodSizeWhenSampled*DistanceToEdge + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.female.proteo))
```

### Firmicutes RA

```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.female.firmic <- glmer(binomial.response ~  fe.fir.abu.RA*ageBinned + ageBinned*habitat + ageBinned*broodSizeWhenSampled + ageBinned*DistanceToEdge + ageBinned*layDateFirst + habitat*broodSizeWhenSampled + habitat*DistanceToEdge + broodSizeWhenSampled*DistanceToEdge + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.female.firmic))
```

# Male only

### shannon
```{r}
offspring.male.shannon <- lmer(nst.shannon ~ m.shannon*ageBinned + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.male.shannon))
```

### chao
```{r}
offspring.male.chao <- lmer(log(nst.chao1) ~ m.chao1*ageBinned + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.male.chao))
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.proteo <- glmer(binomial.response ~  m.pro.abu.RA*ageBinned + ageBinned*habitat + ageBinned*broodSizeWhenSampled + ageBinned*DistanceToEdge + ageBinned*layDateFirst + habitat*broodSizeWhenSampled + habitat*DistanceToEdge + broodSizeWhenSampled*DistanceToEdge + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.male.proteo))
```

### Firmicutes RA

```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.firmic <- glmer(binomial.response ~  m.fir.abu.RA*ageBinned + ageBinned*habitat + ageBinned*broodSizeWhenSampled + ageBinned*DistanceToEdge + ageBinned*layDateFirst + habitat*broodSizeWhenSampled + habitat*DistanceToEdge + broodSizeWhenSampled*DistanceToEdge + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.male.firmic))
```


# results

### Female results
```{r}
offspring.female.shannon.result <- summary(arm::standardize(offspring.female.shannon))[["coefficients"]][,c(1,2,4,5)]
offspring.female.chao.result<- summary(arm::standardize(offspring.female.chao))[["coefficients"]][,c(1,2,4,5)] #drop df column to allow rbind downstream
offspring.female.proteo.result <- summary(arm::standardize(offspring.female.proteo))[["coefficients"]]
offspring.female.firmic.result <- summary(arm::standardize(offspring.female.firmic))[["coefficients"]]
```

this isnt working well because of single variable, when intercept is dropped teh object becomes a numeric vector and loses the rowname i.e. variable name
```{r}
check <- offspring.female.shannon.result[]
check2 <- (offspring.female.shannon.result[2,])
check3 <- matrix(offspring.female.shannon.result[2,])
check4 <- data.frame(offspring.female.shannon.result[2,])

class(check)
class(check2)
class(check3)

#make df of lmer output
# dropping intercept
female.df <- as_tibble(rbind(offspring.female.shannon.result[], offspring.female.chao.result[2,], offspring.female.proteo.result[2,], offspring.female.firmic.result[2,]), rownames="Independent variables") %>% 
  dplyr::rename("P"="Pr(>|t|)") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.fe", replacement = "female") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.m", replacement = "male") %>% 
  mutate_if(is.character, str_replace_all, pattern = "pro.abu.RA", replacement = "proteobacteria") %>% 
  mutate_if(is.character, str_replace_all, pattern = "fir.abu.RA", replacement = "firmicutes") %>% 
  #search for z.fe or z.m and replace
  mutate_if(is.numeric, round, 3) %>%
  mutate(P=ifelse(P==0,"<0.001",P)) #%>% 
  #mutate(P=ifelse(P<=0.05,str_c(P_estimate," *"),P_estimate)) %>%
 # mutate(P=ifelse(P>=0.05 & P<=0.06,str_c(P,"  ."),P))


# make df into kable
## this is in html, dosnt render in word doc # but can copy-paste
female.results <- kable(female.df, format = "html", table.attr = "style = \"color: black;\"") %>%
  kableExtra::group_rows("(a) Shannon diversity ",1,1) %>%
  kableExtra::group_rows("(b) Chao diversity ",2,2) %>%
  kableExtra::group_rows("(c) Proteobacteria RA ",3,3) %>%
  kableExtra::group_rows("(d) Firmicutes RA ",4,4) %>%
  kableExtra::kable_styling(full_width = F) #%>%
  #save_kable("alpha-kable__________.png") # this line saves as .png in Reports/

female.results
```

### Male results
