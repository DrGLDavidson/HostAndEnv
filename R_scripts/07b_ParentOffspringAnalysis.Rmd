---
title: "R Notebook"
output: html_notebook
---

Parent-offspring analysis, JQ request 1 June 2022
Are offspring microbiome traits correlated with parent traits, controlling for woodland site etc.
Related to repeatability discussion

```{r}
rm(list=ls())
```

```{r}
library(lme4)
library(phyloseq)
library(microbiome)
library(tidyverse)
library(lmerTest)
library(kableExtra)
```

```{r}
nstlng.adult.df <- readRDS("../Data/ParentOffspringDF.rds")
```


# Both parents
### Shannon

Both parents correlation with nestling
* ensure only nests with both parents sampled included (38 or 39???)
* control for age, has to be fixed effect due to few factor levels or use nestling ID as random term
* dont think i need to centre and scale because on same scale?
```{r, echo=FALSE, eval=FALSE}
#offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon*ageBinned*m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)
offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon + m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)

#summary(offspring.parents.shannon)

# standardize
summary(arm::standardize(offspring.parents.shannon))
```

### chao
```{r, echo=FALSE, eval=FALSE}
offspring.parents.chao <- lmer(nst.chao1 ~ fe.chao1 + m.chao1 + (1|site/nest/bird.ID), data = nstlng.adult.df)
# standardize
summary(arm::standardize(offspring.parents.chao))
```

How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r, echo=FALSE, eval=FALSE}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

# using adult abundance directly
#offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu + m.pro.abu + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
#summary(arm::standardize(offspring.parents.proteo))

# using adult abundance as fraction
offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu.RA + m.pro.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.proteo))

#  ageBinned * habitat + ageBinned * layDateFirst + ageBinned * broodSizeWhenSampled + ageBinned * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, weights = NumberOfReads, data = proteobacteria.df) # , REML=FALSE not valid argument
```

### Firmicutes RA

```{r, echo=FALSE, eval=FALSE}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.parents.firmic <- glmer(binomial.response ~  fe.fir.abu.RA + m.fir.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.firmic))
```

# Female only
### shannon

Drop bird Id as singular fit

DHARMa residuals poor
* tried dropping brood size or lay date but no difference really
```{r}
offspring.female.shannon <- lmer(nst.shannon ~ fe.shannon + ageBinned + habitat + broodSizeWhenSampled + layDateFirst + (1|site/nest), data = nstlng.adult.df)

offspring.female.shannon.stdz <- arm::standardize(offspring.female.shannon)
summary(offspring.female.shannon.stdz)
```

### chao
Drop bird ID as singular fit
Residual plots good
```{r}
offspring.female.chao <- lmer(log(nst.chao1) ~ fe.chao1 + ageBinned + habitat + broodSizeWhenSampled + layDateFirst +  (1|site/nest), data = nstlng.adult.df)

offspring.female.chao.stdz <- arm::standardize(offspring.female.chao)
summary(offspring.female.chao.stdz)
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA

Residual plots good
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.female.proteo <- glmer(binomial.response ~  fe.pro.abu.RA + ageBinned + habitat + broodSizeWhenSampled + layDateFirst + (1|site/nest/bird.ID) , family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df, control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

offspring.female.proteo.stdz <- arm::standardize(offspring.female.proteo)
  
summary(offspring.female.proteo.stdz)
```

### Firmicutes RA

Residual plots good
```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

#removed: habitat*DistanceToEdge
offspring.female.firmic <- glmer(binomial.response ~  fe.fir.abu.RA + ageBinned + habitat + broodSizeWhenSampled + layDateFirst + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)

offspring.female.firmic.stdz <- arm::standardize(offspring.female.firmic)
  
summary(offspring.female.firmic.stdz)
```

# Male only

### shannon

Drop bird.ID due to singular fit

Residuals poor
```{r}
offspring.male.shannon <- lmer(nst.shannon ~ m.shannon + ageBinned + habitat + broodSizeWhenSampled + layDateFirst +  (1|site/nest), data = nstlng.adult.df)

offspring.male.shannon.stdz <-  arm::standardize(offspring.male.shannon)

summary(offspring.male.shannon.stdz)
```

### chao
Drop bird.ID due to singular fit

DHARMa residuals are fine, squiggly lines but no tests significant
```{r}
offspring.male.chao <- lmer(log(nst.chao1) ~ m.chao1 + ageBinned + habitat + broodSizeWhenSampled + layDateFirst + (1|site/nest), data = nstlng.adult.df)

offspring.male.chao.stdz <-  arm::standardize(offspring.male.chao)

summary(offspring.male.chao.stdz)
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA
DHARMA plots alright
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.proteo <- glmer(binomial.response ~  m.pro.abu.RA + ageBinned + habitat + broodSizeWhenSampled + layDateFirst +  (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)

offspring.male.proteo.stdz <- (arm::standardize(offspring.male.proteo))
summary(offspring.male.proteo.stdz)
```

### Firmicutes RA

DMARMA residuals ok but not great
```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.firmic <- glmer(binomial.response ~  m.fir.abu.RA + ageBinned + habitat + broodSizeWhenSampled + layDateFirst + (1|site/nest), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)

offspring.male.firmic.stdz <- arm::standardize(offspring.male.firmic)
summary(offspring.male.firmic.stdz)
```


# results

### Female results
```{r}
offspring.female.shannon.result <- summary(arm::standardize(offspring.female.shannon))[["coefficients"]][,c(1,2,4,5)]
offspring.female.chao.result<- summary(arm::standardize(offspring.female.chao))[["coefficients"]][,c(1,2,4,5)] #drop df column to allow rbind downstream
offspring.female.proteo.result <- summary(arm::standardize(offspring.female.proteo))[["coefficients"]]
offspring.female.firmic.result <- summary(arm::standardize(offspring.female.firmic))[["coefficients"]]
```

```{r}
#make df of lmer output
# dropping intercept
female.df <- as_tibble(rbind(offspring.female.shannon.result[2:6,], offspring.female.chao.result[2:6,], offspring.female.proteo.result[2:6,], offspring.female.firmic.result[2:6,]), rownames="Independent variables") %>% 
  dplyr::rename("P"="Pr(>|t|)") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.fe", replacement = "female") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.m", replacement = "male") %>% 
  mutate_if(is.character, str_replace_all, pattern = "pro.abu.RA", replacement = "proteobacteria") %>% 
  mutate_if(is.character, str_replace_all, pattern = "fir.abu.RA", replacement = "firmicutes") %>% 
  #search for z.fe or z.m and replace
  mutate_if(is.numeric, round, 3) %>%
  mutate(P=ifelse(P==0,"<0.001",P)) #%>% 
  #mutate(P=ifelse(P<=0.05,str_c(P_estimate," *"),P_estimate)) %>%
 # mutate(P=ifelse(P>=0.05 & P<=0.06,str_c(P,"  ."),P))


# make df into kable
## this is in html, dosnt render in word doc # but can copy-paste
female.results <- kable(female.df, format = "html", table.attr = "style = \"color: black;\"") %>%
  kableExtra::group_rows("(a) Shannon diversity ",1,5) %>%
  kableExtra::group_rows("(b) Chao diversity ",6,10) %>%
  kableExtra::group_rows("(c) Proteobacteria RA ",11,15) %>%
  kableExtra::group_rows("(d) Firmicutes RA ",16,20) %>%
  kableExtra::kable_styling(full_width = F) #%>%
  #save_kable("alpha-kable__________.png") # this line saves as .png in Reports/

female.results
```

### Male results

```{r}
offspring.male.shannon.result <- summary(arm::standardize(offspring.male.shannon))[["coefficients"]][,c(1,2,4,5)]
offspring.male.chao.result<- summary(arm::standardize(offspring.male.chao))[["coefficients"]][,c(1,2,4,5)] #drop df column to allow rbind downstream
offspring.male.proteo.result <- summary(arm::standardize(offspring.male.proteo))[["coefficients"]]
offspring.male.firmic.result <- summary(arm::standardize(offspring.male.firmic))[["coefficients"]]
```

```{r}
#make df of lmer output
# dropping intercept
male.df <- as_tibble(rbind(offspring.male.shannon.result[2:6,], offspring.male.chao.result[2:6,], offspring.male.proteo.result[2:6,], offspring.male.firmic.result[2:6,]), rownames="Independent variables") %>% 
  dplyr::rename("P"="Pr(>|t|)") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.fe", replacement = "male") %>% 
  mutate_if(is.character, str_replace_all, pattern = "z.m", replacement = "male") %>% 
  mutate_if(is.character, str_replace_all, pattern = "pro.abu.RA", replacement = "proteobacteria") %>% 
  mutate_if(is.character, str_replace_all, pattern = "fir.abu.RA", replacement = "firmicutes") %>% 
  #search for z.fe or z.m and replace
  mutate_if(is.numeric, round, 3) %>%
  mutate(P=ifelse(P==0,"<0.001",P)) #%>% 
  #mutate(P=ifelse(P<=0.05,str_c(P_estimate," *"),P_estimate)) %>%
 # mutate(P=ifelse(P>=0.05 & P<=0.06,str_c(P,"  ."),P))


# make df into kable
## this is in html, dosnt render in word doc # but can copy-paste
male.results <- kable(male.df, format = "html", table.attr = "style = \"color: black;\"") %>%
  kableExtra::group_rows("(a) Shannon diversity ",1,5) %>%
  kableExtra::group_rows("(b) Chao diversity ",6,10) %>%
  kableExtra::group_rows("(c) Proteobacteria RA ",11,15) %>%
  kableExtra::group_rows("(d) Firmicutes RA ",16,20) %>%
  kableExtra::kable_styling(full_width = F) #%>%
  #save_kable("alpha-kable__________.png") # this line saves as .png in Reports/

male.results
```