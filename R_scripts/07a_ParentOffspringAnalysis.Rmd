---
title: "R Notebook"
output: html_notebook
---

Parent-offspring analysis, JQ request 1 June 2022
Are offspring microbiome traits correlated with parent traits, controlling for woodland site etc.
Related to repeatability discussion

```{r}
rm(list=ls())
```

```{r}
library(lme4)
library(phyloseq)
library(microbiome)
library(tidyverse)
library(lmerTest)
```

```{r}
phylo.spring <- readRDS(file = "../Data/phylo-spring.rds")
metadata <- meta(phylo.spring) # doesnt maintain Date data-type
```

```{r}
mot <- readRDS("../Data/05_melted.phyla.glom.rds")

proteobacteria.df <- mot[mot$Phylum=="Proteobacteria",]
firmicutes.df <- mot[mot$Phylum=="Firmicutes",]

```

## check samples by nest
how many rows have either male or female sampled
```{r}
tab1 <- data.frame(unclass(table(metadata$nest, metadata$IDLetter)))

sum(tab1$M==1) #how many males sampled
sum(tab1$Fe==1) # how many females sampled
sum(tab1$M==1 & tab1$Fe==1) #how many males and females sampled
sum(tab1$M==1 | tab1$Fe==1) #how many males or females sampled

which(tab1$M==1 & tab1$Fe==1) # which nests have male and female sampled
which(tab1$M==1 | tab1$Fe==1) # which nests have male and female sampled
```

get separate nestling and adult dataframes
```{r}

# # subset to nestlings
phylo.nestlings <- subset_samples(phylo.spring, ageBinned!="adult")
nestling.metadata <- meta(phylo.nestlings@sam_data)

# # subset to adults
phylo.adults <- subset_samples(phylo.spring, ageBinned=="adult")
adults.metadata <- meta(phylo.adults@sam_data)
#adults.limited <- adults.metadata[,c("nest", "bird.ID","Sex", "chao1", "shannon")]

#dput(colnames(adults.metadata))
```

make separate simplified dfs for nestlings, females and males
```{r}
nestling.simple <- nestling.metadata[,c("BIOM.ID" ,"nest", "bird.ID","IDLetter", "chao1", "shannon", "site", "ageBinned")]

fe.simple <- subset(adults.metadata, IDLetter == "Fe")[,c("nest", "bird.ID","IDLetter", "chao1", "shannon")]

m.simple <- subset(adults.metadata, IDLetter == "M")[,c("nest", "bird.ID","IDLetter", "chao1", "shannon")]
```

rename columns to reflect trait origin and add parent IDs as unique cols
```{r}
nestling.simple <- nestling.simple %>% rename(nst.chao1=chao1, nst.shannon = shannon)

fe.simple <- fe.simple %>% rename(fe.chao1=chao1, fe.shannon = shannon, fe.ID = bird.ID) %>% select(-IDLetter)
#fe.simple$fe.ID <- fe.simple$bird.ID

m.simple <- m.simple %>% rename(m.chao1=chao1, m.shannon = shannon, m.ID = bird.ID) %>% select(-IDLetter)
#m.simple$m.ID <- m.simple$bird.ID
```

merge adult info to by nest
```{r}
nstlng.adult.df <- merge(nestling.simple, fe.simple, by = "nest", all.x = TRUE) %>% merge(.,m.simple, by = "nest", all.x = TRUE)
```

filter out nests where adults not sampled (unnecessary?)
```{r}

```

## add phyla RA info

Add proteobacteria trait
```{r}
# add for nestlings
df1 <- proteobacteria.df %>% select(BIOM.ID, Abundance, NumberOfReads)
df2 <- merge(nstlng.adult.df, df1, by = "BIOM.ID", all.x = TRUE) %>% rename(nst.pro.abu = Abundance, nst.NumberOfReads = NumberOfReads)

# add for Fe
df1 <- proteobacteria.df %>% select(bird.ID, Abundance, NumberOfReads) %>% rename(fe.ID = bird.ID)
df2 <- merge(df2, df1, by = "fe.ID", all.x = TRUE) %>% rename(fe.pro.abu = Abundance, fe.NumberOfReads = NumberOfReads)

# add for M
df1 <- proteobacteria.df %>% select(bird.ID, Abundance, NumberOfReads) %>% rename(m.ID = bird.ID)
df2 <- merge(df2, df1, by = "m.ID", all.x = TRUE) %>% rename(m.pro.abu = Abundance, m.NumberOfReads = NumberOfReads)

nstlng.adult.df <- df2
```

Add firmicutes trait
* Dont need NumberOFReads
```{r}
# add for nestlings
df1 <- firmicutes.df %>% select(BIOM.ID, Abundance)
df2 <- merge(nstlng.adult.df, df1, by = "BIOM.ID", all.x = TRUE) %>% rename(nst.fir.abu = Abundance)

# add for Fe
df1 <- firmicutes.df %>% select(bird.ID, Abundance) %>% rename(fe.ID = bird.ID)
df2 <- merge(df2, df1, by = "fe.ID", all.x = TRUE) %>% rename(fe.fir.abu = Abundance)

# add for M
df1 <- firmicutes.df %>% select(bird.ID, Abundance) %>% rename(m.ID = bird.ID)
df2 <- merge(df2, df1, by = "m.ID", all.x = TRUE) %>% rename(m.fir.abu = Abundance)

nstlng.adult.df <- df2
```

Make adult RA a fraction
```{r}

#female
nstlng.adult.df$fe.pro.abu.RA <- nstlng.adult.df$fe.pro.abu/nstlng.adult.df$fe.NumberOfReads

nstlng.adult.df$fe.fir.abu.RA <- nstlng.adult.df$fe.fir.abu/nstlng.adult.df$fe.NumberOfReads

#male
nstlng.adult.df$m.pro.abu.RA <- nstlng.adult.df$m.pro.abu/nstlng.adult.df$m.NumberOfReads

nstlng.adult.df$m.fir.abu.RA <- nstlng.adult.df$m.fir.abu/nstlng.adult.df$m.NumberOfReads

```


# check final df out
```{r}
dput(colnames(nstlng.adult.df))
```

# Both parents
### Shannon

Both parents correlation with nestling
* ensure only nests with both parents sampled included (38 or 39???)
* control for age, has to be fixed effect due to few factor levels or use nestling ID as random term
* dont think i need to centre and scale because on same scale?
```{r}
#offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon*ageBinned*m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)
offspring.parents.shannon <- lmer(nst.shannon ~ fe.shannon + m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)

#summary(offspring.parents.shannon)

# standardize
summary(arm::standardize(offspring.parents.shannon))
```

### chao
```{r}
offspring.parents.chao <- lmer(nst.chao1 ~ fe.chao1 + m.chao1 + (1|site/nest/bird.ID), data = nstlng.adult.df)
# standardize
summary(arm::standardize(offspring.parents.chao))
```

How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

# using adult abundance directly
#offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu + m.pro.abu + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
#summary(arm::standardize(offspring.parents.proteo))

# using adult abundance as fraction
offspring.parents.proteo <- glmer(binomial.response ~  fe.pro.abu.RA + m.pro.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.proteo))

#  ageBinned * habitat + ageBinned * layDateFirst + ageBinned * broodSizeWhenSampled + ageBinned * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, weights = NumberOfReads, data = proteobacteria.df) # , REML=FALSE not valid argument
```

### Firmicutes RA

```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.parents.firmic <- glmer(binomial.response ~  fe.fir.abu.RA + m.fir.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.parents.firmic))
```

# Female only
### shannon

```{r}
offspring.female.shannon <- lmer(nst.shannon ~ fe.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.female.shannon))
```

### chao
```{r}
offspring.female.chao <- lmer(nst.chao1 ~ fe.chao1 + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.female.chao))
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.female.proteo <- glmer(binomial.response ~  fe.pro.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.female.proteo))
```

### Firmicutes RA

```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.female.firmic <- glmer(binomial.response ~  fe.fir.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.female.firmic))
```

# Male only

### shannon
```{r}
offspring.male.shannon <- lmer(nst.shannon ~ m.shannon + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.male.shannon))
```

### chao
```{r}
offspring.male.chao <- lmer(nst.chao1 ~ m.chao1 + (1|site/nest/bird.ID), data = nstlng.adult.df)
summary(arm::standardize(offspring.male.chao))
```


How to control for adult number of reads? Use fraction?

### Proteobacteria RA
```{r}
binomial.response <- c(nstlng.adult.df$nst.pro.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.proteo <- glmer(binomial.response ~  m.pro.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.male.proteo))
```

### Firmicutes RA

```{r}
binomial.response <- c(nstlng.adult.df$nst.fir.abu/nstlng.adult.df$nst.NumberOfReads)

offspring.male.firmic <- glmer(binomial.response ~  m.fir.abu.RA + (1|site/nest/bird.ID), family= binomial, weights = nst.NumberOfReads, data = nstlng.adult.df)
summary(arm::standardize(offspring.male.firmic))
```



