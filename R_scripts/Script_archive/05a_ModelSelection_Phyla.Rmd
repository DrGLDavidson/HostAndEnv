---
title: "R Notebook"
output: html_notebook
---

7/4/21

Model selection on Phylum level glmms of relative abundance.

Overall aim of analysis is to determine which factors influence relative abundance of main phyla. Additionally we will focus on the development of the microbiome over time across the two habitat types.

For the all birds model, where the age-habitat interaction is the main variable of interest, modelling will consist of fitting a global model with all the interactions that seem biologically feasible a priori. Then non-significant interactions will be dropped and the AIC of resulting models will be compared to determine if this improves the model fit, with the aim of increasing the amount of variability explained by the non-focus terms and improving the inference of the effect of age * habitat. Therefore the age-habitat interaction will be exempt from this treatment. AIC measures the information contained in the model, and though it is normally used for improving model prediction it is a relevant model selection method here as we are attempting to increase the amount of variance explained by the model in order to improve our estimates of age * habitat.
* Should non-significant fixed effects therefore also be dropped? Probably yes but i am keeping them in because i want to show the variables that have no effect. Alternatively i could carry out model selection dropping all the non-significant terms and highlighting what remains in the final model.
* This (stepwise) method is expected to inflate significance terms, but will the estimates be affected?

Model selection on the adult only subset is more unclear though. Should AIC be used to select the best model for the sake of consistency? Sex-habitat interaction would be the variable of interest however our samples of adults from coniferous habitats are very low, therefore we can not trust any inference on this term to be close to the truth. The goal of this analysis is to determine which variables explain the variance in relative abundance for the two major phyla and is purely exploratory. Therefore, we should _____________

Overfitting isnt an issue as we are not using the model for prediction, therefore we arent worried about biased parameters. We are only interested in the direction of effects for significant variables*?*

25/8/21
Adding background difference coding to age variable.


# All birds Proteobacteria

```{r}
my.backward.diff = matrix(c(-2/3, 1/3, 1/3, -1/3, -1/3, 2/3), ncol = 2)
my.backward.diff
```

```{r}
levels(proteobacteria.df$ageBinned) # verify: 1week,2week,adult
#assigning the backward difference coding to ageBinned
contrasts(proteobacteria.df$ageBinned) = my.backward.diff
```

*Final model*
```{r Binomial model- Proteobacteria}
binomial.response <- cbind(proteobacteria.df$Abundance,proteobacteria.df$NumberOfReads-proteobacteria.df$Abundance)

all.pro <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled + habitat*DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = proteobacteria.df)

#all.pro <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned:broodSizeWhenSampled +broodSizeWhenSampled + ageBinned:DistanceToEdge:habitat + DistanceToEdge + (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = proteobacteria.df, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(all.pro)
```

Dropped habitat interaction with Distance 
* AIC decreases by 1.8
* use above model
```{r}
all.pro.1 <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled + DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = proteobacteria.df)

summary(all.pro.1)
```

Drop Distance term altogether as not significant in any fixed or interaction term
* AIC decreases by 0.8
* use above model
```{r}
all.pro.3 <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = proteobacteria.df)

summary(all.pro.3)
```

Model validation
* ensure running with final model
* significant deviation
* check over-dispersion: seems fine
* check outliers: seems fine
* check individual predictors: not fine, transform predictors
```{r}
simulationOutput <- simulateResiduals(fittedModel = all.pro, n = 250)
plot(simulationOutput)
```

Plot residuals against individual predictors
```{r}
plotResiduals(simulationOutput, form = metadata.scaled$ageBinned) #fine
plotResiduals(simulationOutput, form = metadata.scaled$habitat) #fine
plotResiduals(simulationOutput, form = metadata.scaled$layDateFirst) #pattern
plotResiduals(simulationOutput, form = metadata.scaled$broodSizeWhenSampled) #residuals larger than expected for low values of BS
plotResiduals(simulationOutput, form = metadata.scaled$DistanceToEdge) #pattern

```

```{r}
testDispersion(simulationOutput)
testOutliers(simulationOutput)
testZeroInflation(simulationOutput)
```

Transform predictors
* sqrt laydate: fails to converge (but note residuals much improved), sqrt of negative values gives NAs
```{r}
binomial.response <- cbind(proteobacteria.df$Abundance,proteobacteria.df$NumberOfReads-proteobacteria.df$Abundance)

all.pro <- glmer(binomial.response ~  ageBinned * habitat * I(sqrt(layDateFirst)) + ageBinned * broodSizeWhenSampled + habitat*DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = proteobacteria.df)

summary(all.pro)
```

```{r}
simulationOutput.edit <- simulateResiduals(fittedModel = all.pro, n = 250)
plot(simulationOutput.edit)
```

```{r}
plotResiduals(simulationOutput.edit, form = metadata.scaled$ageBinned) #fine
plotResiduals(simulationOutput.edit, form = metadata.scaled$habitat) #fine
plotResiduals(simulationOutput.edit, form = metadata.scaled$layDateFirst) #pattern
plotResiduals(simulationOutput.edit, form = metadata.scaled$broodSizeWhenSampled) #residuals larger than expected for low values of BS
plotResiduals(simulationOutput.edit, form = metadata.scaled$DistanceToEdge) #pattern

```

Fit model w/i random effect groupings (site and sequence plate)
```{r}
#unique(proteobacteria.df$site) # BP CB DW FR GT IN KB LS SP
mydata <- subset(proteobacteria.df, proteobacteria.df$site == "BP")
mydata <- subset(proteobacteria.df, proteobacteria.df$SequencePlate == "04/10/2018")

binomial.response.mydata <- cbind(mydata$Abundance,mydata$NumberOfReads-mydata$Abundance)

all.pro <- glmer(binomial.response.mydata ~  ageBinned *habitat* layDateFirst + ageBinned * broodSizeWhenSampled + habitat*DistanceToEdge +  (1|site/nest/bird.ID) , family= binomial, data = mydata)

summary(all.pro)
```
Check residuals for random effects ie refit each model by group
* error maybe due to NAs in predictor or response?
* possible to refit with only one site? As then habitat has only 1 level
```{r}
unique(is.na(proteobacteria.df$habitat))
simulationOutput <- recalculateResiduals(simulationOutput.edit, group = proteobacteria.df$SequencePlate)
```

# All birds: Firmicutes

```{r}
my.backward.diff = matrix(c(-2/3, 1/3, 1/3, -1/3, -1/3, 2/3), ncol = 2)
my.backward.diff
```

```{r}
levels(firmicutes.df$ageBinned) # verify: 1week,2week,adult
#assigning the backward difference coding to ageBinned
contrasts(firmicutes.df$ageBinned) = my.backward.diff
```

Global model
* Model fails to converge
* ALso fails to converge with different optimizer
```{r Binomial model- Firmicutes}
binomial.response <- cbind(firmicutes.df$Abundance,firmicutes.df$NumberOfReads-firmicutes.df$Abundance)

all.fir <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled + habitat*DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = firmicutes.df)#, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 10000000)))

summary(all.fir)
```
check correlation of variables
```{r}
vcov(all.fir)
max(vcov(all.fir))
```

Dropping habitat interaction with distance fixes model WARNING above
*final model*
* residuals poor
```{r}
binomial.response <- cbind(firmicutes.df$Abundance,firmicutes.df$NumberOfReads-firmicutes.df$Abundance)

all.fir.2 <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled + DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = firmicutes.df) 

summary(all.fir.2)
```

Drop distance variable as not significant as fixed term
* model nearly unidentifiable
* AIC decreases by 2
*BUT i said i would keep these non-significant fixed terms*
```{r}
binomial.response <- cbind(firmicutes.df$Abundance,firmicutes.df$NumberOfReads-firmicutes.df$Abundance)

all.fir.3 <- glmer(binomial.response ~  ageBinned * habitat * layDateFirst + ageBinned * broodSizeWhenSampled +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = firmicutes.df) # fits well

summary(all.fir.3)
```

Drop laydate interaction, even tho its significant
* AIC increases alot
* AIC also increases if age*BS interaction dropped
```{r}
binomial.response <- cbind(firmicutes.df$Abundance,firmicutes.df$NumberOfReads-firmicutes.df$Abundance)

all.fir <- glmer(binomial.response ~  ageBinned * habitat + layDateFirst + ageBinned * broodSizeWhenSampled + DistanceToEdge +  (1|site/nest/bird.ID) + (1|SequencePlate), family= binomial, data = firmicutes.df) # fits well

summary(all.fir)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = all.fir.2, n = 250)
plot(simulationOutput)
```

```{r}
plotResiduals(simulationOutput, form = firmicutes.df$ageBinned) #fine
plotResiduals(simulationOutput, form = firmicutes.df$habitat) #fine
plotResiduals(simulationOutput, form = firmicutes.df$layDateFirst) #pattern
plotResiduals(simulationOutput, form = firmicutes.df$broodSizeWhenSampled) #residuals larger than expected for low values of BS
plotResiduals(simulationOutput, form = firmicutes.df$DistanceToEdge) #pattern
```


#Adult birds: Proteobacteria

calc correlation cooefficent for all covariates and RA
```{r}
adult.variables <- c("Sex", "habitat", "layDateFirst", "broodSizeWhenSampled" ,"DistanceToEdge")
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

for (i in adult.variables) {
  result.cor <- cor((proteobacteria.df.adult$Abundance/(proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)), proteobacteria.df.adult$i)
  print(result.cor)
}

cor((proteobacteria.df.adult$Abundance/(proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)), proteobacteria.df.adult$Sex)

cor((proteobacteria.df.adult$Abundance/(proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)), proteobacteria.df.adult$layDateFirst)

cor((proteobacteria.df.adult$Abundance/(proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)), proteobacteria.df.adult$broodSizeWhenSampled)

cor((proteobacteria.df.adult$Abundance/(proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)), proteobacteria.df.adult$DistanceToEdge)
```

Boxplot of sex-habitat for proteobacteria.
* Note: only 4 coniferous males, 3 coniferous females
```{r}
ggplot(proteobacteria.df.adult, aes(Sex, Abundance, color=habitat)) +
  geom_boxplot() +
  ggtitle("Proteobacteria abundance")
```

At first i intended on focussing on Sex*habitat as a term of main interest however this gave conflicting results (term highly significant OR highly non-significant depending on model formula), on reflection this is probably de to small n of adult-conifer. So will proceed with a particular term or variable of interest but will focus more on exploration. AIC will be used as model selection technique to remain consisitent with all-birds model.

Full model (mirror of alpha-div model) converges
* added Sex interaction with habitat*laydate as seems like it would be important and residuals improve
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.1 <- glmer(binomial.response ~ Sex * habitat * broodSizeWhenSampled + habitat * layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult) 

summary(adu.pro.1)
```

See outlier- is it the Distance outlier SP7M?
```{r}
simOut <- simulateResiduals(adu.pro.1, n = 1000)
plot(simOut)
```

Drop habitat interaction with Sex * laydate as least significant 3-way interaction, and habitat * lay date not significant
* AIC drops by 3.9
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.2 <- glmer(binomial.response ~ Sex * habitat * broodSizeWhenSampled + layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult)

summary(adu.pro.2)
```

Drop habitat interaction from habitat*distance in adu.pro.2, as it least significant interaction term
* AIC drops by 1.5
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.3 <- glmer(binomial.response ~ Sex * habitat * broodSizeWhenSampled + layDateFirst * Sex + DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult) # singular fit

summary(adu.pro.3)
```

Separate out 3 way sex*habitat*broodSize into 3 2-way interactions from adu.pro.2
* AIC increases by 0.6
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.4 <- glmer(binomial.response ~ Sex * habitat + habitat * broodSizeWhenSampled + Sex * broodSizeWhenSampled+ layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult) 

summary(adu.pro.4)
```


Separate out 3 way sex*habitat*laydate into 2 2-way interactions 
* model fails to converge
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.5 <- glmer(binomial.response ~ Sex * habitat * broodSizeWhenSampled + habitat * layDateFirst + layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult) 

summary(adu.pro.5)
```

Separate out Sex * habitat * broodSizeWhenSampled
* singular fit
* AIC increases by almost 40,000
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.6 <- glmer(binomial.response ~ Sex * habitat + habitat * broodSizeWhenSampled + habitat * layDateFirst + layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult) # singular fit

summary(adu.pro.6)
```

Drop distance term from adu.pro.2 (AIC 90071.7) as non-significant in fixed and interaction terms
* AIC drops by 2.9
*final model*
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.7 <- glmer(binomial.response ~ Sex * habitat * broodSizeWhenSampled + layDateFirst * Sex + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult)

summary(adu.pro.7)
```

Separate out 3-way interaction from adu.pro.8
* AIC increases by 0.3
```{r}
#proteobacteria.df.adult <- proteobacteria.df.adult[!proteobacteria.df.adult$BIOM.ID=="SP7M.S10",] # extreme outlier for distance
binomial.response <- cbind(proteobacteria.df.adult$Abundance,proteobacteria.df.adult$NumberOfReads-proteobacteria.df.adult$Abundance)

adu.pro.8 <- glmer(binomial.response ~ Sex * habitat + Sex * broodSizeWhenSampled +habitat * broodSizeWhenSampled + layDateFirst * Sex + (1|site/nest) + (1|SequencePlate), family= binomial, data = proteobacteria.df.adult)

summary(adu.pro.8)
```


#Adult birds: Firmicutes

```{r}
ggplot(firmicutes.df.adult, aes(Sex, Abundance, color=habitat)) +
  geom_boxplot() +
  ggtitle("Firmicutes abundance: Adult")
```

Global adult firmicutes
* residuals poor
* final variable list, transform to improve residuals?
```{r}
#firmicutes.df.adult <- subset(firmicutes.df.adult, !BIOM.ID=="SP7M.S10")
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.1 <- glmer(binomial.response ~  Sex * habitat * broodSizeWhenSampled + habitat * layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.1)
```

```{r}
simOut <- simulateResiduals(adu.fir.1, n = 1000)
plot(simOut)
```

Separate out SexM:habitatconifer:broodSizeWhenSampled interaction
* AIC decreases by <2
```{r}
#firmicutes.df.adult <- subset(firmicutes.df.adult, !BIOM.ID=="SP7M.S10")
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.3 <- glmer(binomial.response ~  Sex * habitat + Sex * broodSizeWhenSampled + habitat*broodSizeWhenSampled + habitat * layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.3)
```
Separate out SexM:habitatconifer:layDateFirst
* fails to converge
```{r}
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.4 <- glmer(binomial.response ~  Sex * habitat * broodSizeWhenSampled + habitat * layDateFirst + layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.4)
```

Drop Distance to edge
* AIC decreases by <2
```{r}
#firmicutes.df.adult <- subset(firmicutes.df.adult, !BIOM.ID=="SP7M.S10")
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.5 <- glmer(binomial.response ~  Sex * habitat * broodSizeWhenSampled + habitat * layDateFirst * Sex + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.5)
```

Separate out SexM:habitatconifer:layDateFirst but drop habitat*laydate entirely as non-significant as fixed or interaction, from adu.pro.1
* AIC decreases by <2
```{r}
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.6 <- glmer(binomial.response ~  Sex * habitat * broodSizeWhenSampled + layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.6)
```

Drop habitat*broodSize
* fails to converge
```{r}
#firmicutes.df.adult <- subset(firmicutes.df.adult, !BIOM.ID=="SP7M.S10")
binomial.response <- cbind(firmicutes.df.adult$Abundance,firmicutes.df.adult$NumberOfReads-firmicutes.df.adult$Abundance)

adu.fir.1 <- glmer(binomial.response ~  Sex * broodSizeWhenSampled + habitat * layDateFirst * Sex + habitat * DistanceToEdge + (1|site/nest) + (1|SequencePlate), family= binomial, data = firmicutes.df.adult, control=glmerControl(optCtrl=list(maxfun=200000)))

summary(adu.fir.1)
```

